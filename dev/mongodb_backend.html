<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KnowRob: MongoDB Backend</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-knowrob.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">KnowRob
   &#160;<span id="projectnumber">dev</span>
   </div>
   <div id="projectbrief">AKnowledgeBaseSystemforCognition-enabledRobots</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('mongodb_backend.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">MongoDB Backend </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This package implements a mongo client using libmongoc-1.0.0, and declares a couple of Prolog predicates to interact with mongo DB from Prolog code. This includes predicates used to store, update or retrieve documents, as well as exporting, importing collections, and setting up their search indices.</p>
<p>One usecase is logging of ROS messages, in which case each DB collection corresponds to a ROS topic and is named accordingly. The records in collections are messages published on the topic and their structure is given by ROS message definitions. Using <a href="https://github.com/code-iai/ros-mongodb_log">mongodb-log</a> ROS messages can be recorded in advance or while KnowRob is running. ROS messages are usually stamped, and thus a timestamp value ends up in the DB records that should be used for indexing such that KnowRob can quickly find records given some time instant.</p>
<p>As an example, consider the following DB layout which is based on the <a href="http://docs.ros.org/api/geometry_msgs/html/msg/PoseStamped.html">PoseStamped</a> message send via the communication topic <code>tf</code>: </p><pre class="fragment">{"tf": {
    "header": {
        "seq":      "integer",
        "stamp":    "time",
        "frame_id": "string"
    },
    "pose": {
        "position":    { "x": "double", "y": "double", "z": "double" },
        "orientation": { "x": "double", "y": "double", "z": "double", "w": "double" }
    }
}}
</pre><p>In the layout, the name <code>tf</code> corresponds to a named collection in the DB that collects recorded PoseStamped messages send via the named topic <code>tf</code>. The collection should be indexed by the value <code>header.stamp</code> such that the mongo server can quickly filter out records based on the timestamp when they were acquired. <code>Note</code> in case of array values (as for tf) it is important that the indexed value has identical values for all array members (e.g., the same header stamp in case of tf) &ndash; however, <em>it is advised to avoid generating indices over arrays</em>. For tf, this means that it might be best to store each tranform in an individual document.</p>
<h3><a class="anchor" id="autotoc_md11"></a>
Querying mongo</h3>
<p>Documents in mongo DB can be retrieved by first creating a getAnswerCursor on a named collection, and then reading individual documents until the getAnswerCursor has reached the last document matching the query. Cursors can limit the results, sort them, and filter them according to a pattern given in the query. The query is generally given as Prolog list holding two elements: the value (or operator) and the value. However, to avoid conversion problems, the value must be wrapped in an atom indicating its type.</p>
<p>As an example, below is a query that retrieves documents from a collection named <em>triples</em>. The getAnswerCursor only retrieves documents where the <em>subject</em> value has the value "Obj1", and where the <em>begin</em> field has a date value smaller then the Unix timestamp <em>1579888948.52</em>.</p>
<div class="fragment"><div class="line">mng_cursor_create(roslog,triples,Cursor),</div>
<div class="line">mng_cursor_filter(Cursor,[&#39;subject&#39;,[&#39;$eq&#39;,string(&#39;Obj1&#39;)]]),</div>
<div class="line">mng_cursor_filter(Cursor,[&#39;begin&#39;,[&#39;$lte&#39;,time(1579888948.52)]]),</div>
<div class="line">mng_cursor_next(Cursor,Doc),</div>
<div class="line">mng_cursor_destroy(Cursor).</div>
</div><!-- fragment --><p><code>Note</code> Make sure to destroy a getAnswerCursor once you are done with it. Usually you would want to wrap the getAnswerCursor operation into a call of <em>setup_call_cleanup/3</em>.</p>
<p>More complex filters may use, e.g., disjunction as in:</p>
<div class="fragment"><div class="line">mng_cursor_filter(Cursor,[&#39;$or&#39;,</div>
<div class="line">    array([[&#39;end&#39;,    [&#39;$gte&#39;,time(Stamp)]],</div>
<div class="line">           [&#39;end&#39;,    [&#39;$exists&#39;,bool(0)]]])]).</div>
</div><!-- fragment --><p>These expressions are generically mapped to BSON terms. Hence, any command supported by your mongo server can be written in such an expression. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="backends.html">Data Backends</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
